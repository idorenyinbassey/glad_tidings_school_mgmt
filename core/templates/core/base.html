{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glad Tidings College Portal</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon/logo.png' %}">
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'favicon/logo.png' %}">
  <link rel="apple-touch-icon" href="{% static 'favicon/logo.png' %}">
  <meta name="theme-color" content="#0d6efd" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --accent-color: #ffc107;
        --text-dark: #212529;
        --text-light: #f8f9fa;
      }

      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        /* Default font size for better readability on mobile */
        font-size: 16px;
      }

      main {
        flex: 1;
      }

      /* Mobile-first approach for hero carousel */
      .hero-carousel img {
        height: 50vh;
        object-fit: cover;
      }

      /* For tablet and up */
      @media (min-width: 768px) {
        .hero-carousel img {
          height: 60vh;
        }
      }

      /* For desktop */
      @media (min-width: 992px) {
        .hero-carousel img {
          height: 70vh;
        }
      }

      .hero-caption {
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        padding: 15px;
        /* Ensure captions are visible on mobile */
        display: block !important;
      }

      /* Ensure navbar elements are properly spaced on mobile */
      .navbar-nav {
        margin-top: 1rem;
        width: 100%;
      }

      @media (min-width: 992px) {
        .navbar-nav {
          margin-top: 0;
          width: auto;
        }
      }

      /* Better mobile form experience */
      .form-control {
        margin-bottom: 1rem;
        font-size: 1rem;
        padding: 0.75rem;
      }

      /* Improved buttons for touch targets */
      .btn {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        min-height: 44px;
      }

      /* Accessibility - focus indicators */
      a:focus,
      button:focus,
      input:focus,
      textarea:focus,
      select:focus {
        outline: 3px solid var(--accent-color);
        outline-offset: 2px;
      }

      /* Improved footer spacing */
      footer {
        margin-top: 50px;
        padding: 20px 0;
        background-color: #f8f9fa;
      }

      .social-icons a {
        font-size: 1.2rem;
        margin-right: 0.5rem;
        display: inline-block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
      }

      /* Role-specific styling */
      .admin-feature {
        border-left: 4px solid #dc3545;
      }

      .staff-feature {
        border-left: 4px solid #0dcaf0;
      }

      .student-feature {
        border-left: 4px solid #198754;
      }

      .it-feature {
        border-left: 4px solid #6610f2;
      }

      /* Loading animation for better perceived performance */
      .loading {
        opacity: 0;
        transition: opacity 0.3s ease-in;
      }

      .loaded {
        opacity: 1;
      }

      /* Enhanced carousel image styles */
      .carousel-image {
        background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
          linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
          linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        animation: loading 1s linear infinite;
      }

      .carousel-image.loaded {
        background: none;
        animation: none;
      }

      @keyframes loading {
        0% {
          background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        100% {
          background-position: 20px 20px, 20px 30px, 30px 10px, 10px 20px;
        }
      }

      /* Fallback for failed images */
      .carousel-item {
        background-color: var(--primary-color);
        position: relative;
      }

      .carousel-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <img src="{% static 'favicon/logo.png' %}" alt="Glad Tidings College Logo" class="me-2" style="height:32px;width:auto;" />
          <span class="d-none d-sm-inline">Glad Tidings College</span>
          <span class="d-inline d-sm-none">GTS</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <!-- Public navigation -->
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/"
                ><i class="fas fa-home d-lg-none me-2"></i>Home</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'about_us' %}"
                ><i class="fas fa-info-circle d-lg-none me-2"></i>About Us</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'admission' %}"
                ><i class="fas fa-user-plus d-lg-none me-2"></i>Admission</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'academics' %}"
                ><i class="fas fa-book d-lg-none me-2"></i>Academics</a>
              
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'contact_us' %}"
                ><i class="fas fa-envelope d-lg-none me-2"></i>Contact</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'portal' %}"
                ><i class="fas fa-sign-in-alt d-lg-none me-2"></i>Portal</a
              >
            </li>
          </ul>

          <!-- Role-based navigation -->
          <ul class="navbar-nav ms-auto">
            {% if user.is_authenticated %}
            <li class="nav-item d-lg-none">
              <hr class="dropdown-divider bg-light" />
            </li>

            <!-- Common links for all authenticated users -->
            <li class="nav-item">
              <a class="nav-link" href="{% url 'dashboard' %}"
                ><i class="fas fa-tachometer-alt me-1"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link position-relative"
                href="{% url 'notifications' %}"
              >
                <i class="fas fa-bell me-1"></i> Notifications
                <span
                  class="position-absolute top-0 start-100 translate-middle p-1 bg-danger rounded-circle notification-indicator"
                  id="notification-badge"
                >
                  <span class="visually-hidden">New notifications</span>
                </span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'profile' %}"
                ><i class="fas fa-user-circle me-1"></i> Profile</a
              >
            </li>

            <!-- Student-specific links -->
            {% if user.role == 'student' %}
            <li class="nav-item d-lg-none">
              <hr class="dropdown-divider bg-light" />
            </li>
            <li class="nav-item student-feature">
              <a class="nav-link" href="{% url 'performance_analytics' %}"
                ><i class="fas fa-chart-line me-1"></i> Performance</a
              >
            </li>
            {% endif %}

            <!-- Staff-specific links -->
            {% if user.role == 'staff' %}
            <li class="nav-item d-lg-none">
              <hr class="dropdown-divider bg-light" />
            </li>
            <li class="nav-item staff-feature">
              <a class="nav-link" href="{% url 'elibrary' %}"
                ><i class="fas fa-book-reader me-1"></i> E-Library</a
              >
            </li>
            <li class="nav-item staff-feature">
              <a class="nav-link" href="{% url 'attendance' %}"
                ><i class="fas fa-clipboard-list me-1"></i> Attendance</a
              >
            </li>
            {% endif %}

            <!-- Admin-specific links -->
            {% if user.role == 'admin' %}
            <li class="nav-item d-lg-none">
              <hr class="dropdown-divider bg-light" />
            </li>
            <li class="nav-item admin-feature">
              <a class="nav-link" href="{% url 'elibrary' %}"
                ><i class="fas fa-book-reader me-1"></i> E-Library</a
              >
            </li>
            <li class="nav-item admin-feature">
              <a class="nav-link" href="{% url 'attendance' %}"
                ><i class="fas fa-clipboard-list me-1"></i> Attendance</a
              >
            </li>
            <li class="nav-item admin-feature">
              <a class="nav-link" href="/admin/"
                ><i class="fas fa-user-cog me-1"></i> Admin Panel</a
              >
            </li>
            {% endif %}

            <!-- IT Support-specific links -->
            {% if user.role == 'it_support' %}
            <li class="nav-item d-lg-none">
              <hr class="dropdown-divider bg-light" />
            </li>
            <li class="nav-item it-feature">
              <a class="nav-link" href="/admin/"
                ><i class="fas fa-tools me-1"></i> System Admin</a
              >
            </li>
            {% endif %}

            <!-- Logout -->
            <li class="nav-item d-lg-none">
              <hr class="dropdown-divider bg-light" />
            </li>
            <li class="nav-item">
              <form method="post" action="{% url 'logout' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn nav-link">
                  <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
              </form>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'login' %}"
                ><i class="fas fa-sign-in-alt me-1"></i> Login</a
              >
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="loading">
      {% if messages %}
      <div class="container mt-3">
        {% for message in messages %}
        <div
          class="alert alert-{{ message.tags }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% block content %}{% endblock %}
    </main>

    <footer class="bg-light">
      <div class="container">
        <div class="row">
          <div class="col-md-4 mb-4 mb-md-0">
            <h5>Glad Tidings College</h5>
            <p>Step by Step to Academic Excellence.</p>
          </div>
          <div class="col-md-4 mb-4 mb-md-0">
            <h5>Contact Us</h5>
            <address>
              <p>
                <i class="fas fa-map-marker-alt me-2"></i> Mbiabobong Etoi Uyo (opp. Mobil Estate.Shelter Afrique), Oron Road, Uyo, Nigeria.              </p>
              <p><i class="fas fa-phone me-2"></i> +234 706 857 8415</p>
              <p>
                <i class="fas fa-envelope me-2"></i> info@gladtidingscollege.com.ng
              </p>
            </address>
          </div>
          <div class="col-md-4">
            <h5>Follow Us</h5>
            <div class="social-icons">
              <a href="#" aria-label="Facebook"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a href="#" aria-label="Twitter"
                ><i class="fab fa-twitter"></i
              ></a>
              <a href="#" aria-label="Instagram"
                ><i class="fab fa-instagram"></i
              ></a>
              <a href="#" aria-label="LinkedIn"
                ><i class="fab fa-linkedin-in"></i
              ></a>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12 text-center">
            <p class="mb-0">
              &copy; {% now "Y" %} Glad Tidings College. All rights reserved.
            </p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Page load animation
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelector("main").classList.add("loaded");
      });

      // Add active class to current nav item
      document.addEventListener("DOMContentLoaded", function () {
        const currentLocation = location.pathname;
        const navLinks = document.querySelectorAll(".navbar-nav a.nav-link");
        navLinks.forEach((link) => {
          if (link.getAttribute("href") === currentLocation) {
            link.classList.add("active");
            link.setAttribute("aria-current", "page");
          }
        });
      });

      // Initialize Bootstrap tooltips
      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Notification system functionality
      document.addEventListener("DOMContentLoaded", function () {
        // Only run for authenticated users
        const notificationBadge = document.getElementById("notification-badge");
        if (notificationBadge) {
          // Function to get unread notification count with caching
          function updateNotificationBadge() {
            // Check local storage cache first (valid for 2 minutes)
            const cachedData = localStorage.getItem("notification_count_cache");
            const now = Date.now();

            if (cachedData) {
              const { count, timestamp } = JSON.parse(cachedData);
              // Use cache if less than 2 minutes old
              if (now - timestamp < 120000) {
                updateBadgeDisplay(count);
                return;
              }
            }

            // If cache is expired or doesn't exist, fetch from server
            fetch("/notifications/unread-count/")
              .then((response) => response.json())
              .then((data) => {
                // Update badge
                updateBadgeDisplay(data.count);

                // Cache the result with timestamp
                localStorage.setItem(
                  "notification_count_cache",
                  JSON.stringify({
                    count: data.count,
                    timestamp: now,
                  })
                );
              })
              .catch((error) =>
                console.error("Error fetching notification count:", error)
              );
          }

          // Separate function to update badge display
          function updateBadgeDisplay(count) {
            if (count > 0) {
              notificationBadge.style.display = "block";
            } else {
              notificationBadge.style.display = "none";
            }
          }

          // Update notification badge on page load
          updateNotificationBadge();

          // Set up periodic check for new notifications (every 60 seconds)
          setInterval(updateNotificationBadge, 60000);
        }

        // Handle mark-as-read buttons with AJAX if available
        document.querySelectorAll(".mark-read-form").forEach((form) => {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            const notificationId = this.getAttribute("data-notification-id");
            const notificationItem = this.closest(".list-group-item");
            const csrfToken = this.querySelector(
              'input[name="csrfmiddlewaretoken"]'
            ).value;

            fetch(`/notifications/mark-read/${notificationId}/`, {
              method: "POST",
              headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrfToken,
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  // Remove the unread styling
                  notificationItem.classList.remove("unread-notification");
                  // Hide the mark as read button
                  this.style.display = "none";
                  // Remove the "New" badge
                  const badge =
                    notificationItem.querySelector(".badge.bg-primary");
                  if (badge) badge.remove();
                  // Update the overall notification count
                  if (typeof updateNotificationBadge === "function") {
                    updateNotificationBadge();
                  }
                }
              })
              .catch((error) =>
                console.error("Error marking notification as read:", error)
              );
          });
        });
      });

      // Handle carousel image loading
      document.addEventListener("DOMContentLoaded", function () {
        const carouselImages = document.querySelectorAll(".carousel-image");
        carouselImages.forEach((img) => {
          if (img.complete) {
            img.classList.add("loaded");
          } else {
            img.addEventListener("load", function () {
              this.classList.add("loaded");
            });
            img.addEventListener("error", function () {
              this.classList.add("loaded");
              console.log("Carousel image failed to load, fallback applied");
            });
          }
        });
      });
    </script>

    <!-- Add CSS for notification styling -->
    <style>
      /* Notification styling */
      .notification-indicator {
        display: none;
      }

      .unread-notification {
        border-left: 4px solid var(--primary-color);
        background-color: rgba(13, 110, 253, 0.05);
      }

      .notification-list .list-group-item {
        transition: all 0.3s ease;
      }
    </style>
  </body>
</html>
